{% extends 'users/base.html' %}
{% block title %}训练仪表盘 - {{ project.name }}{% endblock %}

{% block content %}
{% load static %}


<style>
    /* 隐藏左侧菜单栏 */
    .sidebar {
        display: none;
    }
    /* 调整主内容区域的宽度以适应整个页面 */
    .main-panel {
        width: 100%;
        margin-left: 0;
    }
    /* 控制台样式调整 */
    .console {
        width: 25%; /* 控制台宽度调整为25% */
        height: 100vh; /* 控制台高度调整为视口高度 */
    }

    /* 直方图样式调整 */
    .histogram {
        height: 200px;
    }
    .histogram-legend {
        height: 100px;
    }
    /* 平行坐标图和预测图宽度调整 */
    .parallel-coordinates, .prediction-chart {
        width: 40%; /* 平行坐标图和预测图宽度调整为40% */
    }
    /* 确保滚动条显示 */
    .scrollable {
        height: 130px;
        overflow-y: scroll;
    }
    /* 雷达图样式调整 */
    .radar-chart {
        width: 25%; /* 雷达图宽度调整为25% */
        /* height: 300px; 雷达图高度调整为300px */
        
    }
    /* 损失图和重要性图样式调整 */
    .loss-importance-chart {
        width: 25%; /* 损失图和重要性图宽度调整为25% */
        height: 300px; /* 损失图和重要性图高度调整为300px */
    }
    /* 错误信息样式 */
    .error-message {
        color: red;
        margin-top: 10px;
        display: none;
    }
    /* 新增样式规则以缩小标签文字 */
    .small-label {
        font-size: 0.8em; /* 缩小字体大小 */
    }
    /* 新增样式规则以缩小范围显示文字 */
    .small-span {
        font-size: 0.9em; /* 缩小字体大小 */
    }
    /* 新增样式规则以缩小按钮大小 */
    .btn {
        padding: 8px 10px; /* 减小按钮的内边距 */
        font-size: 0.9em; /* 减小按钮的字体大小 */
    }

    /* 参数选择中每一类之间加一些间隙 */
    .parameter-category {
        padding-left: 15px; /* 增加每个参数类别的左侧间距 */
        padding-right: 15px; /* 增加每个参数类别的右侧间距 */
        padding-top: 10px; /* 增加每个参数类别的顶部间距 */
        border-radius: 10px; /* 使背景颜色边缘呈现椭圆形 */
    }

    /* 背景颜色顺序 */
    .parameter-category:nth-child(4n+1),
    .parameter-category:nth-child(4n+3) {
        background-color: #c8c8c8; /* 灰白色 */
    }
    .parameter-category:nth-child(4n+2),
    .parameter-category:nth-child(4n+4) {
        background-color: #eeeeee; /* 白色 */
    }

    /* 新增样式规则以应用到h6标签 */
    .advanced-title {
        font-size: 0.9em; /* 增大字体大小 */
        font-weight: bold; /* 加粗字体 */
        color: #333; /* 设置字体颜色 */
        margin-bottom: 10px; /* 增加底部外边距 */
    }

    
</style>

<!-- 引入 GoJS 库 -->
<script type="module" src="{% static 'js/go-module.js' %}"></script>

<div class="row">
    <!-- Top-left console -->
    <div class="col-md-3 grid-margin stretch-card console">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Console</h4>
                <input type="hidden" id="projectIdInput" value="{{ project.id }}">
                <form method="post" id="trainingForm">
                    {% csrf_token %}
                    <div class="form-group d-flex align-items-center">
                        <label for="dataFileSelect" class="mr-2" style="margin-right: 10px; font-size: 0.9em;">Select Data</label>
                        <select class="form-control form-control-sm" id="dataFileSelect" name="data_file" style="width: auto; height: 8px;">
                            <option value="">Please select a file</option>
                            {% for data_file in data_files %}
                            <option value="{{ data_file.filename }}">{{ data_file.filename }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="featureColumns" class="scrollable" style="display:none;">
                        <h5>Feature Column Selection</h5>
                        <!-- Feature columns will be dynamically added here -->
                    </div>
                    <!-- <div id="parameters" class="scrollable"> -->
                        <h5>Parameter Selection</h5>
                        <!-- Time perception related parameters -->
                        <div class="parameter-category">
                            <h6 class="advanced-title">Spatio-Temporal Perception Related Parameters</h6>
                            <div class="row">
                                <div class="col-sm-6">
                                    <label for="temporal_kernel_size" class="mr-2 small-label" style="margin-right: 5px;">Temporal Kernel Size (<span class="range-min small-span">2</span>-<span class="range-max small-span">128</span>)</label>
                                    <div class="range small-range">
                                        <input type="range" class="form-control-range small-input" id="temporal_kernel_size" name="temporal_kernel_size" min="2" max="128" value="5" style="width: 80%;">
                                        <span class="range-value small-span" id="temporal_kernel_size_value">3</span>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <label for="lstm_units" class="mr-2 small-label" style="margin-right: 5px;">LSTM Units (<span class="range-min small-span">16</span>-<span class="range-max small-span">256</span>)</label>
                                    <div class="range small-range">
                                        <input type="range" class="form-control-range small-input" id="lstm_units" name="lstm_units" min="16" max="256" value="50" style="width: 80%;">
                                        <span class="range-value small-span" id="lstm_units_value">50</span>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <label for="spatial_kernel_sizes" class="mr-2 small-label" style="margin-right: 5px;">Spatial Kernel Size (<span class="range-min small-span">2</span>-<span class="range-max small-span">128</span>)</label>
                                    <div class="range small-range">
                                        <input type="range" class="form-control-range small-input" id="spatial_kernel_sizes" name="spatial_kernel_sizes" min="2" max="128" value="5" style="width: 80%;">
                                        <span class="range-value small-span" id="spatial_kernel_sizes_value">3</span>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <label for="filters" class="mr-2 small-label" style="margin-right: 5px;">Filters (<span class="range-min small-span">8</span>-<span class="range-max small-span">128</span>)</label>
                                    <div class="range small-range">
                                        <input type="range" class="form-control-range small-input" id="filters" name="filters" min="8" max="128" value="64" style="width: 80%;">
                                        <span class="range-value small-span" id="filters_value">64</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Attention mechanism and fully connected layer -->
                        <div class="parameter-category">
                            <h6 class="advanced-title">Attention Mechanism and Fully Connected Layer</h6>
                            <div class="row">
                                <div class="col-sm-6">
                                    <label for="dynamic_attention_units" class="mr-2 small-label" style="margin-right: 5px;">Dynamic Attention Units (<span class="range-min small-span">16</span>-<span class="range-max small-span">256</span>)</label>
                                    <div class="range small-range">
                                        <input type="range" class="form-control-range small-input" id="dynamic_attention_units" name="dynamic_attention_units" min="16" max="256" value="6" style="width: 80%;">
                                        <span class="range-value small-span" id="dynamic_attention_units_value">50</span>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <label for="dense_units" class="mr-2 small-label" style="margin-right: 5px;">Dense Units (<span class="range-min small-span">16</span>-<span class="range-max small-span">256</span>)</label>
                                    <div class="range small-range">
                                        <input type="range" class="form-control-range small-input" id="dense_units" name="dense_units" min="16" max="256" value="50" style="width: 80%;">
                                        <span class="range-value small-span" id="dense_units_value">50</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Training related parameters -->
                        <div class="parameter-category">
                            <h6 class="advanced-title">Training Related Parameters</h6>
                            <div class="row">
                                <div class="col-sm-6">
                                    <label for="epochs" class="mr-2 small-label" style="margin-right: 5px;">Epochs (<span class="range-min small-span" id="epochs-min">5</span>-<span class="range-max small-span" id="epochs-max">200</span>)</label>
                                    <div class="range small-range">
                                        <input type="range" class="form-control-range small-input" id="epochs" name="epochs" min="5" max="200" value="10" style="width: 80%;">
                                        <span class="range-value small-span" id="epochs_value">10</span>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <label for="batch_size" class="mr-2 small-label" style="margin-right: 5px;">Batch Size (<span class="range-min small-span" id="batch_size-min">8</span>-<span class="range-max small-span" id="batch_size-max">256</span>)</label>
                                    <div class="range small-range">
                                        <input type="range" class="form-control-range small-input" id="batch_size" name="batch_size" min="8" max="256" value="32" style="width: 80%;">
                                        <span class="range-value small-span" id="batch_size_value">32</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <!-- </div> -->
                    <div class="form-group d-flex align-items-center" style="margin-top: 20px; "> 
                        <label for="testSizeRatio" class="mr-2" style="margin-right: 10px; font-size: 1em;">Training and Test Set Ratio</label>
                        <input type="number" step="0.01" min="0.01" max="0.99" class="form-control" id="testSizeRatio" name="test_size_ratio" value="0.2" style="width: auto; height: 8px;">
                    </div>
                    <div class="progress mb-3" style="height: 20px; "> 
                        <div id="trainingProgress" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                    <button type="button" class="btn btn-danger" id="viewDataButton" disabled onclick="generateAndFetchData() " style="font-size: 0.85em;">View Data</button>
                    <button type="button" class="btn btn-warning ml-2" id="bayesianOptimizationButton" disabled onclick="startBayesianOptimization()" style="font-size: 0.85em;">Hyperparameters</button>
                    <button type="button" class="btn btn-primary" id="trainButton" disabled onclick="startTraining()" style="font-size: 0.85em;">Train</button>
                    <button type="button" class="btn btn-success ml-2" id="saveButton" disabled onclick="saveModel()" style="font-size: 0.85em;">Save</button>
                    
                </form>
                <!-- Add error message display area -->
                <div id="errorMessage" class="error-message"></div>
            </div>
        </div>
        
    </div>
    <!-- Top-middle time histogram -->
    <div class="col-md-4 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">
                    <span onclick="toggleHistogram('time')">Time Histogram</span>
                    <span onclick="toggleHistogram('geo')">Geographic Histogram</span>
                </h4>
                <canvas id="timeHistogramCanvas" class="histogram"></canvas>
                <div id="timeLegend" class="histogram-legend"></div>
            </div>
        </div>
    </div>
    <!-- Top-right parallel coordinates chart -->
    <div class="col-md-5 grid-margin stretch-card parallel-coordinates">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">
                    Parallel Coordinates Chart
                    
                </h4>
                <div id="parallelCoordinatesContainer" style="width: 100%; height: 300px;"></div>
            </div>
        </div>
    </div>
    <!-- Bottom-left radar chart -->
    <div class="col-md-3 grid-margin stretch-card radar-chart">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Radar Chart</h4>
                <div id="radarChartContainer" style="width: 100%; height: 400px;"></div>
            </div>
        </div>
    </div>
    <!-- Bottom-middle loss chart and importance chart -->
    <div class="col-md-4 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Loss Chart</h4>
                <div id="lossChartSVG" style="width: 100%; height: 200px;"></div>
                <h4 class="card-title">Importance Ranking Chart</h4>
                <div id="importanceChartSVG" style="width: 100%; height: 200px;"></div>
            </div>
        </div>
    </div>
    <!-- Bottom-right prediction chart -->
    <div class="col-md-5 grid-margin stretch-card prediction-chart">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Training Result Prediction Chart</h4>
                <div id="predictionChartSVG" style="width: 100%; height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- 添加贝叶斯优化开始模态窗口 -->
<!-- Bayesian optimization start modal window -->
<div class="modal fade" id="bayesianOptimizationModal" tabindex="-1" role="dialog" aria-labelledby="bayesianOptimizationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bayesianOptimizationModalLabel">Bayesian Optimization Settings</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <label for="bayesianOptimizationCalls">Bayesian optimization runs (10-100)</label>
                <div class="form-group d-flex align-items-center">
                    <input type="range" class="form-control-range" id="bayesianOptimizationCalls" name="bayesianOptimizationCalls" min="10" max="100" value="10" style="width: 80%;">
                    <span class="range-value small-span" id="bayesianOptimizationCallsValue">10</span>
                </div>
                <!-- Weight selection inputs -->
                <h5>Bayesian optimization weight selection, adjust weights according to requirements (the more important, the larger the weight)</h5>
                <label for="w1">RMSE Weight</label>
                <div class="form-group d-flex align-items-center">
                    <input type="number" step="0.01" min="0" max="1" class="form-control" id="w1" name="w1" value="0.25" style="width: 80%;">
                </div>
                <label for="w2">MAE Weight</label>
                <div class="form-group d-flex align-items-center">
                    <input type="number" step="0.01" min="0" max="1" class="form-control" id="w2" name="w2" value="0.25" style="width: 80%;">
                </div>
                <label for="w3">1-NSE Weight</label>
                <div class="form-group d-flex align-items-center">
                    <input type="number" step="0.01" min="0" max="1" class="form-control" id="w3" name="w3" value="0.5" style="width: 80%;">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="startBayesianOptimizationWithModal()">Start Optimization</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal window for parameter range reduction after Bayesian optimization -->
<div class="modal fade" id="parameterUpdateModal" tabindex="-1" role="dialog" aria-labelledby="parameterUpdateModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="parameterUpdateModalLabel">Bayesian Optimization Results</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="parameterUpdateModalBody">
                <!-- Parameters will be dynamically added here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateParametersButton">Yes, Narrow Parameter Range</button>
                <button type="button" class="btn btn-info" id="keepParametersButton">No, Update Parameter Values Only</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加帮助模态框中的流程图 -->
<!-- Flowchart in help modal -->
<div class="modal fade" id="helpModal" tabindex="-1" role="dialog" aria-labelledby="helpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="helpModalLabel">Help Documentation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h4>Features of This Interface</h4>
                <p>This interface allows you to train models in multiple ways. Here are the main functions:</p>
                <ul>
                    <li><strong>View Data:</strong> Visualize training data and provide general parameter range suggestions.</li>
                    <li><strong>Narrow Parameter Range:</strong> Use Bayesian optimization to initially find good parameter combinations according to the selected number of training runs, providing narrow parameter range recommendations.</li>
                    <li><strong>Train:</strong> Train according to the features and parameters selected in the console. After training, visualize the results and provide parameter adjustment suggestions based on the results (not necessarily completely accurate, please modify according to actual needs).</li>
                    <li><strong>Save:</strong> Save the model obtained from current training.</li>
                </ul>
                
                <h4>Flowcharts</h4>
                <!-- Add three div containers for displaying flowcharts -->
                <div class="row">
                    <div class="col-md-4">
                        <h5>Process One (Simply narrow range then train, advantage: saves time)</h5>
                        <div id="myDiagramDiv1" style="border: solid 1px black; width:100%; height:400px "></div>
                    </div>
                    <div class="col-md-4">
                        <h5>Process Two (Detailed narrowing of range then train, advantage: easier to get better models)</h5>
                        <div id="myDiagramDiv2" style="border: solid 1px black; width:100%; height:400px"></div>
                    </div>
                    <div class="col-md-4">
                        <h5>Process Three (Direct training, advantage: high flexibility)</h5>
                        <div id="myDiagramDiv3" style="border: solid 1px black; width:100%; height:400px"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>



<script src="{% static 'js/training_dash_1.js' %}"></script>
<script src="{% static 'js/training_dash_2.js' %}"></script>
<script src="{% static 'js/training_dash_3.js' %}"></script>

{% endblock %}